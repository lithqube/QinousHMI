<?xml version="1.0" encoding="UTF-8"?>
<html xmlns:atv="http://webmi.atvise.com/2007/svgext" xmlns:o="urn:schemas-microsoft-com:office:office" xmlns:svg="http://www.w3.org/2000/svg" xmlns:v="urn:schemas-microsoft-com:vml" xmlns:xlink="http://www.w3.org/1999/xlink" xmlns="http://www.w3.org/1999/xhtml">
 <head>
  <title></title>
  <style>v\:*{behavior:url(#default#VML)}body{overflow:hidden}</style>
  <meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/>
 </head>
 <body>
  <v:group atv:coordfactor="100" atv:oe="2BD6F3BA9386L2KEE9ICI6H8M7O4P31F365AECD499I181IBLDHCP3HBN5KFQDC83" coordsize="96400,60000" id="webmivmlroot" style="height:600px;left:0;position:absolute;top:0;visibility:hidden;width:964px">
   <v:oval fillcolor="#151fbd" id="id_33" strokecolor="#e87a68" stroked="true" strokeweight="0.75" style="height:37600px;left:-23600px;top:40600px;width:67600px"/>
   <v:group atv:origtransform="matrix(0.9207,0,0,0.9207,-111.5829,-10.0846)" atv:refpx="18424" atv:refpy="3588" coordorigin="-30033,-3494" coordsize="236435,64449" id="tab_active" style="height:64449px;left:-30033px;top:-3494px;width:236435px">
    <v:roundrect arcsize="0.09" atv:refpx="12717" atv:refpy="3824" fillcolor="#4A5055" id="box_active" stroked="false" strokeweight="0.69" style="height:3176px;left:5000px;top:2260px;width:11048px"/>
    <v:polyline atv:matrix="0.9207,0,0,0.9207,-111.5829,-10.0846" fillcolor="#face9e" id="id_20" points="16002,53405 51357,50827 77505,4 61117,8659 45004,44934 16002,53405 " strokecolor="#192ae4" stroked="true" strokeweight="3.45"/>
    <v:oval fillcolor="#8a540a" id="id_26" strokecolor="#ac2513" stroked="true" strokeweight="1.38" style="height:64449px;left:-21746px;top:-3494px;width:64449px"/>
    <v:line fillcolor="#5b6a71" from="19777,21180" id="id_24" strokecolor="#ca5c9a" stroked="true" strokeweight="2.07" to="27143,22746">
     <v:stroke joinstyle="miter"/>
    </v:line>
    <v:line atv:refpx="18500" atv:refpy="5350" from="6402 4171" id="txt_active" to="206402 4271">
     <v:skew matrix="0.9097,0,0,0.9207" on="true" origin="-0.53201,-42.21348"/>
     <v:path textpathok="true"/>
     <v:fill color="#ffffff" on="true"/>
     <v:stroke on="false"/>
     <v:textpath on="true" string="Aktiv" style="font-family:'Varela Round';font-size:16px;v-text-align:left"/>
    </v:line>
    <v:line fillcolor="#3dbe92" from="25394,44290" id="id_23" strokecolor="#9b7ab6" stroked="true" strokeweight="1.38" to="22908,35083">
     <v:stroke joinstyle="miter"/>
    </v:line>
    <v:oval fillcolor="#b3d862" id="id_15" strokecolor="#71c84a" stroked="true" strokeweight="2.76" style="height:5892px;left:-30033px;top:30203px;width:75682px"/>
    <v:rect fillcolor="#364930" id="id_9" strokecolor="#cd89c8" stroked="true" strokeweight="2.07" style="height:9851px;left:19869px;top:25968px;width:49534px"/>
   </v:group>
   <v:line fillcolor="#3e9362" from="70700,19000" id="id_27" strokecolor="#663c32" stroked="true" strokeweight="3.75" to="91700,20200">
    <v:stroke joinstyle="miter"/>
   </v:line>
   <v:group atv:origtransform="matrix(0.9207,0,0,0.9207,-106.6704,-10.0846)" atv:refpx="30424" atv:refpy="3588" coordorigin="-15086,2260" coordsize="234681,76648" id="tab_history" style="height:76648px;left:-15086px;top:2260px;width:234681px">
    <v:oval fillcolor="#205b1c" id="id_31" strokecolor="#8a7642" stroked="true" strokeweight="1.38" style="height:39038px;left:565px;top:24679px;width:39038px"/>
    <v:polyline atv:matrix="0.9207,0,0,0.9207,-106.6704,-10.0846" fillcolor="#c8837b" id="id_16" points="34263,26981 -5327,3871 -447,30572 33527,37937 -4959,27717 50744,12710 14100,8475 34263,26981 " strokecolor="#48efe9" stroked="true" strokeweight="2.07"/>
    <v:rect fillcolor="#8227d3" id="id_7" strokecolor="#f5c738" stroked="true" strokeweight="2.76" style="height:27989px;left:-539px;top:5989px;width:42168px"/>
    <v:roundrect arcsize="0.084" atv:refpx="22524" atv:refpy="3848" fillcolor="#ffffff" id="box_history" stroked="false" strokeweight="0.69" style="height:3176px;left:17000px;top:2260px;width:11048px"/>
    <v:oval fillcolor="#18ebf8" id="id_5" strokecolor="#20ba48" stroked="true" strokeweight="1.38" style="height:24859px;left:-15086px;top:33794px;width:9575px"/>
    <v:oval fillcolor="#49444c" id="id_4" strokecolor="#a5cbb1" stroked="true" strokeweight="0.69" style="height:60766px;left:42641px;top:18142px;width:60766px"/>
    <v:rect fillcolor="#b02d17" id="id_2" strokecolor="#779d55" stroked="true" strokeweight="2.76" style="height:16757px;left:77904px;top:25692px;width:0px"/>
    <v:line atv:refpx="31052" atv:refpy="5400" from="19595 4221" id="txt_history" to="219595 4321">
     <v:skew matrix="0.9097,0,0,0.9207" on="true" origin="-0.59797,-42.71348"/>
     <v:path textpathok="true"/>
     <v:fill color="#dbdcdd" on="true"/>
     <v:stroke on="false"/>
     <v:textpath on="true" string="History" style="font-family:'Varela Round';font-size:16px;v-text-align:left"/>
    </v:line>
    <v:polyline atv:matrix="0.9207,0,0,0.9207,-106.6704,-10.0846" fillcolor="#172a48" id="id_12" points="15757,13078 25056,53957 4340,44934 9220,22193 62989,13631 33250,24587 40984,7922 14836,13354 15297,35820 71828,27257 15757,13078 " strokecolor="#821ded" stroked="true" strokeweight="1.38"/>
   </v:group>
   <v:line fillcolor="#1fb546" from="96300,13000" id="id_32" strokecolor="#3d8967" stroked="true" strokeweight="2.25" to="78100,47100">
    <v:stroke joinstyle="miter"/>
   </v:line>
   <v:rect fillcolor="#72136d" id="id_29" strokecolor="#c01f50" stroked="true" strokeweight="0.75" style="height:25700px;left:73900px;top:9700px;width:13100px"/>
   <v:group atv:origtransform="matrix(0.9207,0,0,0.9207,0,0)" coordorigin="5000,3800" coordsize="103579,55000" style="height:55000px;left:5000px;top:3800px;width:103579px">
    <v:group atv:origx="5431" atv:origy="5713" atv:refpx="489.072" atv:refpy="335.416" coordsize="78000,57000" id="id_1" style="height:57000px;left:0;top:0;width:78000px">
     <v:oval fillcolor="#a40424" id="id_28" strokecolor="#9af3d1" stroked="true" strokeweight="3.45" style="height:26148px;left:66595px;top:16124px;width:26148px"/>
     <v:oval fillcolor="#8c3da9" id="id_10" strokecolor="#d863da" stroked="true" strokeweight="0.69" style="height:41063px;left:8591px;top:6917px;width:41063px"/>
     <v:group atv:refpx="40965" atv:refpy="31891" atv:table-height="600" atv:table-width="800" coordorigin="5000,3800" coordsize="103579,55000" id="id_1_grid" style="height:55000px;left:5000px;top:3800px;width:103579px">
      <v:oval fillcolor="#77558c" id="id_30" strokecolor="#bba8dc" stroked="true" strokeweight="0.69" style="height:51927px;left:57940px;top:5444px;width:50639px"/>
      <v:oval fillcolor="#5554c5" id="id_25" strokecolor="#d46d7b" stroked="true" strokeweight="2.76" style="height:10128px;left:34647px;top:43377px;width:10128px"/>
      <v:rect atv:refpx="41828" atv:refpy="32881" id="id_1_rect1" stroked="false" strokeweight="0.92" style="height:52480px;left:5000px;top:5260px;width:71815px"/>
      <v:polyline atv:matrix="0.9207,0,0,0.9207,50.0005,52.6005" fillcolor="#feba9a" id="id_22" points="45971,51479 26544,27357 41644,59397 25532,35367 76538,8759 84180,46876 63280,43193 24059,30856 51127,58292 37685,23398 " strokecolor="#80166c" stroked="true" strokeweight="3.45">
       <v:stroke joinstyle="miter"/>
      </v:polyline>
      <v:oval fillcolor="#50bdaa" id="id_3" strokecolor="#843985" stroked="true" strokeweight="2.07" style="height:22465px;left:40539px;top:15388px;width:22465px"/>
     </v:group>
    </v:group>
   </v:group>
  </v:group>
  <script type="text/javascript" src="../../webmi.js"></script>
  <script type="text/javascript" src="/q/TableFunctions.js"></script>
  <script type="text/javascript" src="/q/AlarmInfo.js"></script>
  <script type="text/javascript" src="/q/StdConstantsFunctions.js"></script>
  <script type="text/javascript" src="/scope.js"></script>
  <script type="text/javascript">//<![CDATA[
webMI.proxy({"":[function(webMI,window,document,self){var boxActive = document.getElementById("box_active");
	txtActive = document.getElementById("txt_active");
	boxHistory = document.getElementById("box_history");
	txtHistory = document.getElementById("txt_history");

webMI.addEvent("tab_active", ["mouseover","touchstart"], function(e){
	document.getElementById("tab_active").setAttribute('style', "cursor: pointer;");		
});


// Microinteractions
webMI.addEvent("tab_active", ["click","touchend"], function(e) {
setActive();
});

webMI.addEvent("tab_history", ["click","touchend"], function(e) {
setHistoy();
});

function setActive(){
			boxActive.setAttribute("fill","#4A5055");
			txtActive.setAttribute("fill","#FFFFFF");
			boxHistory.setAttribute("fill","#FAFAFA");		
			txtHistory.setAttribute("fill","#E3E5E5");
}	

function setHistoy(){
			boxHistory.setAttribute("fill","#4A5055");		
			txtActive.setAttribute("fill","#E3E5E5");
			boxActive.setAttribute("fill","#FAFAFA");
			txtHistory.setAttribute("fill","#FFFFFF");
}

webMI.callExtension("SYSTEM.LIBRARY.PROJECT.QUICKDYNAMICS.Theme", {"action":"font family", "defaultValue":"font family", "id":"txt_history", "key":"FontFamily", "property":""});

webMI.callExtension("SYSTEM.LIBRARY.PROJECT.QUICKDYNAMICS.Theme", {"action":"font family", "defaultValue":"font family", "id":"txt_active", "key":"FontFamily", "property":""});
},{"id_1":["1",{}]},{}],"1":[function(webMI,window,document,self){var $ = top.$;
var headers = [];
var linefill = "#FFFFFF";
var nodearray = [];
var atviseTable;
var alarmList;

var earliestIndex;

// setup blank table
atviseTable = webMI.callExtension("SYSTEM.LIBRARY.ATVISE.QUICKDYNAMICS.Table", { "gElement": document.getElementById("grid"), "sortedByColumn":0, "autoResize":false});

atviseTable.setConfiguration({rowHeight:35,sortingUp:true,autoResize:true, drawStatusBar:false});
headers.push({name: "Owner", width: 200, fontSize: fontSize});
headers.push({name: "Level", width: 100, fontSize: fontSize});
headers.push({name: "Name", width: 500, fontSize: fontSize});

atviseTable.setHeaders(headers);


// - - - - - - - - - - - -

webMI.addOnload(function(f){
	webMI.trigger.fire("GetAlarmsFromCurrentNode");		
});// END For

// - - - - - - - - - - - -


webMI.trigger.connect("UpdateAlarmsFromCurrentNode", function(e){

	activeAlarmList = e.value[0];
	var alarmHistoryInfo = e.value[1];

//	console.log("Got an alarm history information structure ", alarmHistoryInfo);

	//======= ACTIVE ALARMS TAB==========
	for (var i=0; i<activeAlarmList.length; i++) {	

		var datarow = [];
		datarow[0] = {text: activeAlarmList[i].owner, fill:linefill};//, eventList: eventList};
		datarow[1] = {text: getAlarmLevelString(activeAlarmList[i].level), fill:linefill};
		datarow[2] = {text: activeAlarmList[i].name, fill:linefill};
		nodearray[i] = datarow;	

	}
	atviseTable.setDataProvider({data: nodearray});

	var alarmWordHistory = [];

	//========= ALARM HISTORY TAB=======
	if (alarmHistoryInfo.length > 0){


		for (var i=0; i< alarmHistoryInfo.length; i++){

//			console.log("Getting recorder contents ", alarmHistoryInfo[i]);
			// get TOC for this recorder		
			Scope.getContent(
				alarmHistoryInfo[i].recorder, 
				tocCallback(alarmHistoryInfo[i], alarmWordHistory));
		}
	}
});


tocCallback = function(alarmHistoryInfo, alarmWordHistory){

	return function(e){

		if (e === undefined) {
//			console.log("No such recorder methinks");
			return;
		}
		var toc = e
		var newestIndex = 0;
			
		for (var i=0; i<toc.length; i++){					
			var newestIndex = Math.max(newestIndex, toc[i].idxstart);
		}

		// request most recent lines from DB for alarmHistoryInfo[i].recorder, alarmHistoryInfo[i].alarmList. callback using alarmHistoryInfo[i].alarmMasksList
		Scope.readIndex(
			alarmHistoryInfo.recorder, 
			alarmHistoryInfo.alarms, 
			newestIndex, 
			newestIndex + 10000, 
			false, 
			addScopeResultsToAlarmHistoryCallback(alarmHistoryInfo, alarmWordHistory));

	}
}
},{},{}]},window);
//]]></script>
 </body>
</html>
