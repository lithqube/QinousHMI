<?xml version="1.0" encoding="UTF-8"?>
<html xmlns:atv="http://webmi.atvise.com/2007/svgext" xmlns:o="urn:schemas-microsoft-com:office:office" xmlns:v="urn:schemas-microsoft-com:vml" xmlns:xlink="http://www.w3.org/1999/xlink" xmlns="http://www.w3.org/1999/xhtml">
 <head>
  <title></title>
  <style>v\:*{behavior:url(#default#VML)}body{overflow:hidden}</style>
  <meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/>
 </head>
 <body>
  <v:group atv:coordfactor="100" atv:oe="2BC6E3AA8376K2JED9HCH6G8L7N4O2GF264ADCC489H171HBKDGCO3GBM5JFPCR82" coordsize="78000,57000" id="webmivmlroot" style="height:570px;left:0;position:absolute;top:0;visibility:hidden;width:780px">
   <v:rect fillcolor="#9bfb14" id="id_31" strokecolor="#9a8cb2" stroked="true" strokeweight="0.75" style="height:31800px;left:55700px;top:12100px;width:8800px"/>
   <v:polyline fillcolor="#276dca" id="id_30" points="41800,51100 75900,24400 26500,0 42700,32500 4100,15600 13300,42200 47800,13600 31200,22700 43200,20400 68200,32800 45400,56200 32300,7800 41800,51100 " strokecolor="#f3f78e" stroked="true" strokeweight="3.75"/>
   <v:rect fillcolor="#b6f979" id="id_29" strokecolor="#c312c5" stroked="true" strokeweight="2.25" style="height:3600px;left:75300px;top:17600px;width:1000px"/>
   <v:polyline fillcolor="#e2a3ea" id="id_28" points="18700,55700 36700,53100 61100,42900 75100,25100 38500,52100 15800,2000 38700,18100 26300,30500 64500,48100 20400,53400 44300,39600 " strokecolor="#9abf11" stroked="true" strokeweight="3">
    <v:stroke joinstyle="miter"/>
   </v:polyline>
   <v:oval fillcolor="#7e9714" id="id_27" strokecolor="#0f135b" stroked="true" strokeweight="3" style="height:31000px;left:57300px;top:24000px;width:31000px"/>
   <v:oval fillcolor="#72836d" id="id_26" strokecolor="#aeeae4" stroked="true" strokeweight="3.75" style="height:32800px;left:-25500px;top:29800px;width:67000px"/>
   <v:polyline fillcolor="#da7d87" id="id_23" points="69100,28100 10500,39700 24300,29200 24400,48700 77100,27000 60800,13300 41100,6500 57800,49100 51100,42400 " strokecolor="#d6ae62" stroked="true" strokeweight="2.25">
    <v:stroke joinstyle="miter"/>
   </v:polyline>
   <v:oval fillcolor="#f3ba8c" id="id_21" strokecolor="#aa7996" stroked="true" strokeweight="2.25" style="height:14200px;left:67100px;top:27700px;width:14200px"/>
   <v:oval fillcolor="#069bd8" id="id_20" strokecolor="#0ad1b6" stroked="true" strokeweight="1.5" style="height:26000px;left:43700px;top:18100px;width:26000px"/>
   <v:oval fillcolor="#be548d" id="id_19" strokecolor="#995793" stroked="true" strokeweight="3" style="height:200px;left:42000px;top:8200px;width:17200px"/>
   <v:group atv:refpx="39062" atv:refpy="28925" atv:table-height="600" atv:table-width="800" coordorigin="-3400,-16200" coordsize="81400,99300" id="grid" style="height:99300px;left:-3400px;top:-16200px;width:81400px">
    <v:oval fillcolor="#7a6c8e" id="id_32" strokecolor="#fc55b2" stroked="true" strokeweight="0.75" style="height:16400px;left:12800px;top:27800px;width:16400px"/>
    <v:rect fillcolor="#f1fa7e" id="id_25" strokecolor="#661958" stroked="true" strokeweight="0.75" style="height:300px;left:74100px;top:55200px;width:600px"/>
    <v:oval fillcolor="#4cfcf4" id="id_24" strokecolor="#7a4e0d" stroked="true" strokeweight="0.75" style="height:7600px;left:55400px;top:8700px;width:7600px"/>
    <v:rect fillcolor="#c3c508" id="id_22" strokecolor="#7f68b8" stroked="true" strokeweight="0.75" style="height:100px;left:77100px;top:56200px;width:700px"/>
    <v:line fillcolor="#354c48" from="4900,12600" id="id_18" strokecolor="#d97eb6" stroked="true" strokeweight="2.25" to="26400,9400">
     <v:stroke joinstyle="miter"/>
    </v:line>
    <v:polyline fillcolor="#96f9f3" id="id_15" points="75500,47500 43700,20400 69000,26200 36100,17200 64200,54700 7600,1100 29800,3900 58600,36200 38800,39200 28200,20700 8100,24300 75500,47500 " strokecolor="#bf97fd" stroked="true" strokeweight="3"/>
    <v:rect atv:refpx="40000" atv:refpy="30000" id="rect1" stroked="false" strokeweight="1" style="height:57000px;left:0px;top:0px;width:78000px"/>
    <v:polyline fillcolor="#cc573d" id="id_14" points="13500,9300 59000,9700 35300,39100 46100,26000 69800,35000 5000,100 47500,29100 13500,50200 43600,1600 72800,16100 25200,5500 55400,28900 13500,9300 " strokecolor="#582abb" stroked="true" strokeweight="2.25"/>
    <v:oval fillcolor="#6d2d2d" id="id_12" strokecolor="#107ec2" stroked="true" strokeweight="2.25" style="height:56000px;left:-3400px;top:27100px;width:17600px"/>
    <v:oval fillcolor="#cb880e" id="id_11" strokecolor="#8f2938" stroked="true" strokeweight="3" style="height:36000px;left:6100px;top:18500px;width:12200px"/>
    <v:oval fillcolor="#2836c2" id="id_8" strokecolor="#68243c" stroked="true" strokeweight="3" style="height:33600px;left:30600px;top:-16200px;width:33600px"/>
    <v:line fillcolor="#3f4535" from="46800,29100" id="id_7" strokecolor="#a41e35" stroked="true" strokeweight="3.75" to="26500,12100">
     <v:stroke joinstyle="miter"/>
    </v:line>
    <v:oval fillcolor="#923732" id="id_4" strokecolor="#75275e" stroked="true" strokeweight="3" style="height:24400px;left:30500px;top:27100px;width:31000px"/>
   </v:group>
  </v:group>
  <script type="text/javascript" src="../../webmi.js"></script>
  <script type="text/javascript" src="/q/AlarmInfo.js"></script>
  <script type="text/javascript" src="/q/StdConstantsFunctions.js"></script>
  <script type="text/javascript" src="/scope.js"></script>
  <script type="text/javascript">//<![CDATA[
webMI.proxy({"":[function(webMI,window,document,self){var $ = top.$;
var headers = [];
var linefill = "#FFFFFF";
var nodearray = [];
var atviseTable;
var alarmList;

var earliestIndex;

// setup blank table
atviseTable = webMI.callExtension("SYSTEM.LIBRARY.ATVISE.QUICKDYNAMICS.Table", { "gElement": document.getElementById("grid"), "sortedByColumn":0, "autoResize":false});

atviseTable.setConfiguration({rowHeight:35,sortingUp:true,autoResize:true, drawStatusBar:false});
headers.push({name: "Owner", width: 200, fontSize: fontSize});
headers.push({name: "Level", width: 100, fontSize: fontSize});
headers.push({name: "Name", width: 500, fontSize: fontSize});

atviseTable.setHeaders(headers);


// - - - - - - - - - - - -

webMI.addOnload(function(f){
	webMI.trigger.fire("GetAlarmsFromCurrentNode");		
});// END For

// - - - - - - - - - - - -


webMI.trigger.connect("UpdateAlarmsFromCurrentNode", function(e){

	activeAlarmList = e.value[0];
	var alarmHistoryInfo = e.value[1];

//	console.log("Got an alarm history information structure ", alarmHistoryInfo);

	//======= ACTIVE ALARMS TAB==========
	for (var i=0; i<activeAlarmList.length; i++) {	

		var datarow = [];
		datarow[0] = {text: activeAlarmList[i].owner, fill:linefill};//, eventList: eventList};
		datarow[1] = {text: getAlarmLevelString(activeAlarmList[i].level), fill:linefill};
		datarow[2] = {text: activeAlarmList[i].name, fill:linefill};
		nodearray[i] = datarow;	

	}
	atviseTable.setDataProvider({data: nodearray});

	var alarmWordHistory = [];

	//========= ALARM HISTORY TAB=======
	if (alarmHistoryInfo.length > 0){


		for (var i=0; i< alarmHistoryInfo.length; i++){

//			console.log("Getting recorder contents ", alarmHistoryInfo[i]);
			// get TOC for this recorder		
			Scope.getContent(
				alarmHistoryInfo[i].recorder, 
				tocCallback(alarmHistoryInfo[i], alarmWordHistory));
		}
	}
});


tocCallback = function(alarmHistoryInfo, alarmWordHistory){

	return function(e){

		if (e === undefined) {
//			console.log("No such recorder methinks");
			return;
		}
		var toc = e
		var newestIndex = 0;
			
		for (var i=0; i<toc.length; i++){					
			var newestIndex = Math.max(newestIndex, toc[i].idxstart);
		}

		// request most recent lines from DB for alarmHistoryInfo[i].recorder, alarmHistoryInfo[i].alarmList. callback using alarmHistoryInfo[i].alarmMasksList
		Scope.readIndex(
			alarmHistoryInfo.recorder, 
			alarmHistoryInfo.alarms, 
			newestIndex, 
			newestIndex + 10000, 
			false, 
			addScopeResultsToAlarmHistoryCallback(alarmHistoryInfo, alarmWordHistory));

	}
}
},{},{}]},window);
//]]></script>
 </body>
</html>
